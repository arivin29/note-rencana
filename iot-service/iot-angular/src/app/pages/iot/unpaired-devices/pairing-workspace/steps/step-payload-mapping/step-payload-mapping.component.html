<card class="mb-4">
    <card-body>
        <h2 class="step-title">
            <i class="fa fa-exchange-alt me-2"></i>
            Step 3: Payload Mapping
        </h2>
        <p class="step-description">Map payload fields to sensor channels using drag & drop</p>

        <div class="row g-3">
            <div class="col-md-4">
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted mb-2" style="font-size: 0.75rem; font-weight: 600;">
                        <i class="fa fa-code me-1"></i>
                        Payload Fields
                    </h6>
                    <p class="text-muted small mb-2">Drag fields to channels</p>
                </div>

                <div *ngIf="selectedPayload" class="mb-2 small">
                    <strong>Topic:</strong> <span class="text-muted">{{ selectedPayload.topic }}</span>
                </div>

                <div cdkDropList id="payload-fields" [cdkDropListData]="payloadFields"
                    [cdkDropListConnectedTo]="connectedDropLists" 
                    class="list-group list-group-flush">
                    <div *ngFor="let field of payloadFields" 
                        class="list-group-item border-0 py-2 px-2" 
                        cdkDrag 
                        [cdkDragData]="field"
                        style="cursor: move; background: transparent;">
                        <div class="d-flex align-items-start gap-2">
                            <i class="fa fa-grip-vertical text-muted mt-1" style="font-size: 0.75rem;"></i>
                            <div class="flex-grow-1" style="min-width: 0;">
                                <div class="text-truncate small fw-semibold" [title]="field.path">
                                    {{ field.path }}
                                </div>
                                <div class="d-flex gap-2 align-items-center mt-1">
                                    <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ field.type }}</span>
                                    <span class="text-muted small text-truncate" style="font-size: 0.75rem;">
                                        {{ field.displayValue }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-8">
                <div class="mb-3">
                    <h6 class="text-uppercase text-muted mb-2" style="font-size: 0.75rem; font-weight: 600;">
                        <i class="fa fa-sitemap me-1"></i>
                        Channel Mapping
                    </h6>
                    <p class="text-muted small mb-2">Drop payload fields onto channels</p>
                </div>

                <!-- Profile Suggestions (Compact) -->
                <div class="card mb-3" *ngIf="profileSuggestions.length > 0">
                    <div class="card-body py-2">
                        <div class="d-flex align-items-center gap-2">
                            <div class="flex-grow-1">
                                <select class="form-select form-select-sm" [(ngModel)]="selectedProfileId"
                                    (change)="handleProfileSelection()">
                                    <option [ngValue]="null">ðŸ’¡ Use saved profile...</option>
                                    <option *ngFor="let suggestion of profileSuggestions"
                                        [ngValue]="suggestion.profile.idNodeProfile">
                                        {{ suggestion.profile.name }} ({{ (suggestion.matchScore * 100) | number:'1.0-0' }}%)
                                    </option>
                                </select>
                            </div>
                            <button class="btn btn-outline-secondary btn-sm" type="button" (click)="loadProfiles()"
                                [disabled]="profileLoading">
                                <i class="fa fa-rotate"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Metadata Mapping (Compact) -->
                <div class="mb-3">
                    <div class="small text-muted mb-2 fw-semibold">Telemetry Metadata</div>
                    <div class="row g-2">
                        <div class="col-md-4" *ngFor="let target of metaTargets">
                            <div class="card">
                                <div class="card-body p-2">
                                    <div class="small fw-semibold mb-1">{{ target.label }}</div>
                                    <div cdkDropList 
                                        class="border rounded p-2 bg-light" 
                                        style="min-height: 40px;"
                                        [id]="getMetaDropId(target.key)"
                                        [cdkDropListData]="target" 
                                        [cdkDropListConnectedTo]="connectedDropLists"
                                        (cdkDropListDropped)="onMetaDrop($event, target.key)"
                                        [class.bg-success-subtle]="getMetaMapping(target.key)">
                                        <div *ngIf="!getMetaMapping(target.key)" class="text-muted small text-center">
                                            Drop here
                                        </div>
                                        <div *ngIf="getMetaMapping(target.key)" class="d-flex align-items-center justify-content-between">
                                            <span class="small text-truncate">
                                                <i class="fa fa-link me-1"></i>
                                                {{ getMetaMapping(target.key)?.path }}
                                            </span>
                                            <button class="btn btn-sm btn-link text-danger p-0" 
                                                (click)="onMetaMappingRemoved(target.key)"
                                                title="Remove">
                                                <i class="fa fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sensor List (Compact) -->
                <div class="mb-3">
                    <div class="small text-muted mb-2 fw-semibold">Sensors & Channels</div>
                    <div class="accordion" id="sensorAccordion">
                        <div class="accordion-item" *ngFor="let sensor of addedSensors; let i = index">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" 
                                    data-bs-toggle="collapse"
                                    [attr.data-bs-target]="'#sensor-' + i"
                                    (click)="selectSensor(sensor)">
                                    <i class="fa fa-microchip me-2"></i>
                                    <strong>{{ sensor.label }}</strong>
                                    <span class="ms-2 text-muted small">
                                        ({{ getEnabledChannels(sensor).length }} channels)
                                    </span>
                                </button>
                            </h2>
                            <div [id]="'sensor-' + i" 
                                class="accordion-collapse collapse"
                                data-bs-parent="#sensorAccordion">
                                <div class="accordion-body p-2">
                                    <div *ngFor="let channel of getEnabledChannels(sensor)" class="mb-2">
                                        <div class="d-flex align-items-start gap-2">
                                            <div class="flex-shrink-0" style="width: 40%;">
                                                <div class="small fw-semibold">{{ channel.template.channelName }}</div>
                                                <div class="text-muted" style="font-size: 0.7rem;">
                                                    {{ channel.template.unit || 'N/A' }}
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <div cdkDropList 
                                                    class="border rounded p-2 bg-light" 
                                                    style="min-height: 40px;"
                                                    [id]="'drop-' + channel.tempId"
                                                    [cdkDropListData]="channel" 
                                                    [cdkDropListConnectedTo]="connectedDropLists"
                                                    (cdkDropListDropped)="onFieldDrop($event, channel)"
                                                    [class.bg-success-subtle]="channel.mappedField">
                                                    
                                                    <div *ngIf="!channel.mappedField" class="text-muted small text-center">
                                                        <i class="fa fa-arrow-left me-1"></i>
                                                        Drop field
                                                    </div>

                                                    <div *ngIf="channel.mappedField" class="d-flex align-items-center justify-content-between">
                                                        <div class="flex-grow-1" style="min-width: 0;">
                                                            <div class="small fw-semibold text-truncate">
                                                                <i class="fa fa-link me-1"></i>
                                                                {{ channel.mappedField.path }}
                                                            </div>
                                                            <div class="text-muted text-truncate" style="font-size: 0.7rem;">
                                                                {{ channel.mappedField.displayValue }}
                                                            </div>
                                                        </div>
                                                        <button class="btn btn-sm btn-link text-danger p-0 ms-2" 
                                                            (click)="onMappingRemoved(channel)"
                                                            title="Remove">
                                                            <i class="fa fa-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Save Profile Form -->
                <div class="card mt-3" *ngIf="!profileSaved">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <div class="meta-label">Save As Profile</div>
                                <div class="meta-text">Store this mapping so similar payloads can reuse it instantly
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Profile Code *</label>
                                <input class="form-control" [(ngModel)]="profileForm.code"
                                    (ngModelChange)="markProfileDirty()" placeholder="e.g., ESP32-WATER-001">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Profile Name *</label>
                                <input class="form-control" [(ngModel)]="profileForm.name"
                                    (ngModelChange)="markProfileDirty()" placeholder="Water Station Mapping">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Parser Type *</label>
                                <select class="form-select" [(ngModel)]="profileForm.parserType"
                                    (ngModelChange)="markProfileDirty()">
                                    <option value="json">JSON</option>
                                    <option value="binary">Binary</option>
                                    <option value="custom">Custom Script</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Description</label>
                                <input class="form-control" [(ngModel)]="profileForm.description"
                                    (ngModelChange)="markProfileDirty()" placeholder="Short note for this profile">
                            </div>
                            <div class="col-12 mb-3">
                                <label class="form-label">Transform Script (optional)</label>
                                <textarea class="form-control" rows="2" [(ngModel)]="profileForm.transformScript"
                                    (ngModelChange)="markProfileDirty()"
                                    placeholder="// Type any custom JS transform here"></textarea>
                            </div>
                        </div>
                        <div *ngIf="profileSaveMessage" class="alert alert-success py-2">{{ profileSaveMessage }}</div>
                        <div *ngIf="profileSaveError" class="alert alert-danger py-2">{{ profileSaveError }}</div>
                        <div class="d-flex justify-content-end">
                            <button class="btn btn-theme" type="button" (click)="saveProfile()"
                                [disabled]="isSavingProfile || !profileFormValid">
                                <span *ngIf="!isSavingProfile">Save Profile</span>
                                <span *ngIf="isSavingProfile">
                                    <span class="spinner-border spinner-border-sm me-1"></span>
                                    Saving...
                                </span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div *ngIf="!addedSensors.length" class="empty-state">
            <i class="fa fa-arrow-up fa-3x mb-3 text-muted"></i>
            <p class="text-muted">Add sensors on Step 2 to start mapping</p>
        </div>
    </card-body>
</card>