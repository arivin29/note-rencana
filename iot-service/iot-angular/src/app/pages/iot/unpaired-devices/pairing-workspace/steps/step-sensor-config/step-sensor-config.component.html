<card class="mb-4">
  <card-body>
    <div class="step-title-row">
      <div>
        <h2 class="step-title">
          <i class="fa fa-microchip me-2"></i>
          Step 2: Add Sensors
        </h2>
        <p class="step-description">Select sensors from the catalog and configure their channels</p>
      </div>
      <span class="badge bg-success-subtle text-success fw-semibold align-self-start">
        {{ addedSensors.length }} configured
      </span>
    </div>

  <card class="mt-4">
    <card-header class="d-flex align-items-center bg-inverse bg-opacity-10 fw-400 flex-wrap gap-2">
      Sensor Channels
      <div class="ms-auto d-flex gap-2 flex-wrap align-items-center">
        <a href="javascript:;" class="text-decoration-none text-inverse text-opacity-50">
          <i class="fa fa-chart-line me-1"></i>
          View Telemetry Graph
        </a>
        <button type="button" class="btn btn-theme btn-sm" (click)="openAddSensorDrawer()" [disabled]="!id_node">
          <i class="fa fa-plus me-1"></i>
          Add Sensor
        </button>
      </div>
    </card-header>
    <card-body class="p-0">
      <div *ngIf="addedSensors.length === 0" class="sensor-empty text-center">
        <i class="fa fa-inbox fa-3x mb-3 text-muted"></i>
        <div class="fw-semibold text-muted mb-1">No sensors configured yet</div>
        <p class="text-muted small mb-0">Click Add Sensor to begin defining your configuration</p>
      </div>

      <div *ngFor="let sensor of addedSensors; let idx = index" class="sensor-block p-3"
           [ngClass]="{ 'border-top': idx > 0 }">
        <div class="d-flex flex-wrap align-items-center gap-2">
          <div class="me-auto">
            <div class="fw-semibold">{{ sensor.label }}</div>
            <div class="text-muted small">
              ID {{ sensor.tempId }} · Catalog {{ sensor.catalog.name }}
            </div>
            <div class="text-muted small">
              {{ sensor.catalog.manufacturer }} · {{ sensor.protocolChannel || 'Channel N/A' }} · Sampling —s
            </div>
          </div>
          <button class="btn btn-outline-theme btn-sm" type="button" (click)="openAddChannelDrawer(sensor)" [disabled]="!sensor.tempId">
            <i class="fa fa-plus me-1"></i>
            Add Channel
          </button>
          <button class="btn btn-outline-secondary btn-sm" type="button" (click)="openEditSensorDrawer(sensor)"
                  title="Edit sensor configuration">
            <i class="fa fa-pen me-1"></i>
            Edit
          </button>
          <button class="btn btn-outline-danger btn-sm" type="button" (click)="deleteSensor(sensor)"
                  [disabled]="sensor.channels.length > 0"
                  [title]="sensor.channels.length > 0 ? 'Cannot delete sensor with channels' : 'Delete sensor'">
            <i class="fa fa-trash me-1"></i>
            Delete
          </button>
          <span class="badge bg-success-subtle text-success">Active</span>
          <div class="text-muted small">
            {{ sensor.channels.length }} channel{{ sensor.channels.length > 1 ? 's' : '' }}
          </div>
        </div>
        <div class="table-responsive mt-3">
          <table class="table table-sm align-middle mb-0">
            <thead class="text-uppercase text-muted small">
              <tr>
                <th>Sensor Type</th>
                <th>Metric</th>
                <th>Channel ID</th>
                <th class="text-end">Latest</th>
                <th>Status</th>
                <th class="text-end">Include</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let channel of sensor.channels">
                <td class="fw-semibold">
                  <a href="javascript:;" class="text-decoration-none text-theme">
                    <i class="fa fa-chart-line me-1"></i>
                    {{ channel.template.channelName }}
                  </a>
                </td>
                <td>
                  <div>{{ channel.template.metricName }}</div>
                  <div class="text-muted small text-uppercase">
                    {{ channel.template.unit || 'N/A' }}
                  </div>
                </td>
                <td class="text-muted small">{{ channel.template.channelCode }}</td>
                <td class="text-end fw-semibold text-muted">—</td>
                <td>
                  <span class="badge" [ngClass]="channel.enabled ? 'bg-success' : 'bg-secondary'">
                    {{ channel.enabled ? 'Enabled' : 'Disabled' }}
                  </span>
                </td>
                <td class="text-end">
                  <div class="form-check form-switch d-inline-flex align-items-center gap-2 m-0 justify-content-end">
                    <input type="checkbox"
                           class="form-check-input"
                           [checked]="channel.enabled"
                           (change)="handleToggleChannel(channel)"
                           [id]="'toggle-' + channel.tempId">
                    <label class="form-check-label text-muted small" [for]="'toggle-' + channel.tempId">
                      {{ channel.enabled ? 'Included' : 'Excluded' }}
                    </label>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </card-body>
  </card>
    <pw-add-sensor-drawer
    [isOpen]="sensorDrawerState.isOpen"
    [nodeId]="id_node || ''"
    [sensorId]="sensorDrawerState.sensorId"
    (close)="handleSensorDrawerClose()"
    (save)="handleSensorDrawerSave()">
  </pw-add-sensor-drawer>

    <pw-add-channel-drawer
    [isOpen]="channelDrawerState.isOpen"
    [sensorId]="channelDrawerState.sensorId"
    [sensorLabel]="channelDrawerState.sensorLabel"
    [channelId]="channelDrawerState.channelId"
    [mode]="channelDrawerState.mode"
    (close)="handleChannelDrawerClose()"
    (save)="handleChannelDrawerSave()">
  </pw-add-channel-drawer>
  </card-body>
</card>
