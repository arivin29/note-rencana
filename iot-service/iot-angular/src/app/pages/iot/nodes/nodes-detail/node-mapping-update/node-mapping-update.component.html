<div class="mapping-wrapper" *ngIf="!loading">
  <h2 class="step-title">
    <i class="fa fa-edit me-2"></i>
    Payload Mapping Configuration
  </h2>
  <p class="step-description">Drag payload fields to map them to sensor channels</p>

  <div class="config-summary">
    <!-- Node Configuration -->
    <div class="summary-section">
      <h4 class="summary-title">
        <i class="fa fa-server me-2"></i>
        Node Configuration
      </h4>
      <div class="summary-content" *ngIf="nodeDashboard">
        <div class="summary-row">
          <span class="summary-label">Node Code:</span>
          <span class="summary-value">{{ nodeDashboard.node?.code }}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Serial Number:</span>
          <span class="summary-value">{{ nodeDashboard.node?.serialNumber }}</span>
        </div>
        <div class="summary-row" *ngIf="nodeDashboard.node?.nodeModel?.modelName">
          <span class="summary-label">Model:</span>
          <span class="summary-value">{{ nodeDashboard.node?.nodeModel?.modelName }}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Status:</span>
          <span class="summary-value">
            <span class="badge" 
                  [class.bg-success]="nodeDashboard.node?.connectivityStatus === 'online'"
                  [class.bg-danger]="nodeDashboard.node?.connectivityStatus !== 'online'">
              {{ nodeDashboard.node?.connectivityStatus }}
            </span>
          </span>
        </div>
        <div class="summary-row" *ngIf="profileDetail">
          <span class="summary-label">Sensor Profile:</span>
          <span class="summary-value">
            {{ profileDetail.name }} ({{ profileDetail.parserType | uppercase }})
          </span>
        </div>
      </div>
    </div>

    <!-- Available Payload Fields -->
    <div class="row">
        <div class="col-6">
            <div class="summary-section">
                <div class="small text-muted mb-2 fw-semibold text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <i class="fa fa-file-code me-1"></i>
                    Available Payload Fields (Drag to map)
                </div>
                
                <!-- Log Selection Dropdown -->
                <div class="mb-3" *ngIf="recentLogs.length > 0">
                    <label class="form-label small">Select Payload Source:</label>
                    <select class="form-select form-select-sm" 
                            [(ngModel)]="selectedLogIndex" 
                            (change)="updatePayloadFieldsFromLog(+selectedLogIndex)">
                        <option *ngFor="let log of recentLogs; let i = index" [value]="i">
                            {{ getLogDisplayInfo(log, i) }}
                        </option>
                    </select>
                    <div class="small text-muted mt-1">
                        <i class="fa fa-info-circle me-1"></i>
                        Showing {{ payloadFields.length }} fields from selected log
                    </div>
                </div>
                
                <div cdkDropList 
                     id="payload-fields" 
                     [cdkDropListData]="payloadFields"
                     [cdkDropListConnectedTo]="connectedDropLists"
                     class="payload-fields-container">
                    <div *ngFor="let field of payloadFields" 
                         class="payload-field-tag" 
                         cdkDrag 
                         [cdkDragData]="field">
                        <i class="fa fa-grip-vertical me-2"></i>
                        {{ field }}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6">
            <!-- Telemetry Metadata Mapping -->
            <div class="mb-3">
                <div class="small text-muted mb-2 fw-semibold text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <i class="fa fa-tags me-1"></i>
                    Telemetry Metadata
                </div>
                <div class="row g-2">
                    <div class="col-md-4" *ngFor="let target of metaTargets">
                        <div class="card metadata-card">
                            <div class="card-body p-2">
                                <div class="small fw-semibold mb-1">
                                    <i [class]="target.icon + ' me-1'"></i>
                                    {{ target.label }}
                                </div>
                                <div cdkDropList [id]="getMetaDropId(target.key)" [cdkDropListData]="target"
                                    [cdkDropListConnectedTo]="connectedDropLists"
                                    (cdkDropListDropped)="onMetaDrop($event, target.key)"
                                    class="metadata-drop-zone border rounded p-2"
                                    [class.bg-success-subtle]="getMetaMapping(target.key)"
                                    [class.bg-light]="!getMetaMapping(target.key)">
                                    <div *ngIf="!getMetaMapping(target.key)" class="text-muted small text-center">
                                        Drop here
                                    </div>
                                    <div *ngIf="getMetaMapping(target.key)"
                                        class="d-flex align-items-center justify-content-between">
                                        <span class="small text-truncate">
                                            <i class="fa fa-link me-1"></i>
                                            {{ getMetaMapping(target.key)?.path }}
                                        </span>
                                        <button class="btn btn-sm btn-link text-danger p-0"
                                            (click)="onMetaMappingRemoved(target.key)" title="Remove">
                                            <i class="fa fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sensors & Channels -->
            <div class="summary-section">
                <div class="small text-muted mb-2 fw-semibold text-uppercase" style="font-size: 0.75rem; letter-spacing: 0.05em;">
                    <i class="fa fa-microchip me-1"></i>
                    Sensors & Channels ({{ getSensorsWithChannels().length }})
                </div>
            
                <div class="alert alert-info" *ngIf="getSensorsWithChannels().length === 0">
                    <i class="fa fa-info-circle me-2"></i>
                    No sensors with channels available for this node.
                </div>
            
                <div *ngFor="let sensor of getSensorsWithChannels()" class="sensor-summary">
                    <div class="sensor-summary-header">
                        <i class="fa fa-microchip me-2"></i>
                        {{ sensor.sensorCode }}
                        <span class="text-muted ms-2">({{ sensor.catalogName }})</span>
                        <span class="badge ms-auto" [class.bg-success]="sensor.status === 'active'"
                            [class.bg-secondary]="sensor.status !== 'active'">
                            {{ sensor.status }}
                        </span>
                    </div>
            
                    <div class="channels-summary">
                        <div *ngIf="sensor.channels.length === 0" class="text-muted text-center py-3">
                            No channels defined for this sensor
                        </div>
            
                        <div *ngFor="let channel of sensor.channels" class="channel-summary-row">
                            <div class="d-flex w-100 justify-content-between align-items-center mb-2">
                                <span class="channel-name">
                                    <i class="fa fa-chart-line me-1"></i>
                                    {{ channel.metricCode }}
                                </span>
                                <span class="channel-meta text-muted small">
                                    Unit: {{ channel.unit }}
                                    <span *ngIf="channel.latestValue !== undefined" class="ms-2">
                                        | Latest: {{ channel.latestValue }}
                                    </span>
                                </span>
                            </div>
            
                            <!-- Drop Zone -->
                            <div cdkDropList 
                                 [id]="'drop-' + channel.metricCode"
                                 [cdkDropListData]="channel"
                                 [cdkDropListConnectedTo]="connectedDropLists"
                                 (cdkDropListDropped)="onDrop($event, channel.metricCode)"
                                 class="channel-drop-zone">
                                <div class="channel-mapping" *ngIf="getChannelMapping(channel.metricCode)">
                                    <i class="fa fa-arrow-left me-1"></i>
                                    {{ getChannelMapping(channel.metricCode) }}
                                    <button class="btn-remove-mapping" (click)="removeMapping(channel.metricCode)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                                <div class="drop-placeholder" *ngIf="!getChannelMapping(channel.metricCode)">
                                    <i class="fa fa-arrow-down me-2"></i>
                                    Drop payload field here to map
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    

    <!-- Profile Details -->
    <div class="summary-section" *ngIf="profileDetail">
      <h4 class="summary-title">
        <i class="fa fa-id-card me-2"></i>
        Profile Details
      </h4>
      <div class="summary-content">
        <div class="summary-row">
          <span class="summary-label">Name:</span>
          <span class="summary-value">{{ profileDetail.name }}</span>
        </div>
        <div class="summary-row" *ngIf="profileDetail.description">
          <span class="summary-label">Description:</span>
          <span class="summary-value">{{ profileDetail.description }}</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Parser Type:</span>
          <span class="summary-value">{{ profileDetail.parserType | uppercase }}</span>
        </div>
      </div>
    </div>

    <!-- Current Mapping JSON -->
    <div class="summary-section">
      <h4 class="summary-title">
        <i class="fa fa-code me-2"></i>
        Current Mapping (JSON Preview)
      </h4>
      <pre class="final-payload-json">{{ getMappingJsonPreview() | json }}</pre>
    </div>
  </div>

  <div class="text-end mt-4">
    <button class="btn btn-outline-secondary me-2" (click)="closeDrawer()">
      <i class="fa fa-times me-1"></i>
      Cancel
    </button>
    <button class="btn btn-success" (click)="saveMapping()" [disabled]="loading">
      <i class="fa fa-save me-1"></i>
      Save Mapping
    </button>
  </div>
</div>

<div class="loading-overlay" *ngIf="loading">
  <div class="spinner-container">
    <i class="fa fa-spinner fa-spin fa-3x text-primary"></i>
    <p class="mt-3">Loading data...</p>
  </div>
</div>
