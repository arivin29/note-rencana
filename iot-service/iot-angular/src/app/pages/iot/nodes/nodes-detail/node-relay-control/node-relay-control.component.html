<card class="relay-control-card">
    <!-- Card Header -->
    <div class="card">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-0">
                    <i class="bi bi-plug-fill me-2"></i>
                    Relay Control
                </h5>
                <small class="text-white-50">Node: {{ nodeCode || deviceId }}</small>
            </div>
            <div>
                <span class="badge" [ngClass]="mqttConnected ? 'bg-success' : 'bg-danger'">
                    <i class="bi" [ngClass]="mqttConnected ? 'bi-wifi' : 'bi-wifi-off'"></i>
                    {{ mqttConnected ? 'Connected' : 'Disconnected' }}
                </span>
            </div>
        </div>

        <div class="card-body">
            <!-- MQTT Status Warning -->
            <div class="alert alert-warning d-flex align-items-center" *ngIf="!mqttConnected">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                <div>
                    <strong>MQTT Disconnected</strong><br>
                    Backend is not connected to MQTT broker. Relay commands cannot be sent.
                </div>
            </div>

            <!-- Relay Controls -->
            <div class="row g-3">
                <!-- Relay OUT1 -->
                <div class="col-md-6">
                    <div class="relay-card" [ngClass]="getRelayStateClass('out1')">
                        <div class="relay-header">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-white">
                                    <i [ngClass]="getRelayStateIcon('out1')" class="me-2"></i>
                                    Relay OUT1
                                </h6>
                                <span class="badge bg-white text-dark">
                                    {{ relayState.out1.toUpperCase() }}
                                </span>
                            </div>
                            <p class="small mb-3 text-white-50">
                                Common use: Hard reboot / Power cycle
                            </p>
                        </div>

                        <div class="relay-controls">
                            <div class="btn-group w-100" role="group">
                                <button 
                                    type="button" 
                                    class="btn btn-light"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="turnOn('out1')">
                                    <i class="bi bi-power me-1"></i>
                                    ON
                                </button>
                                <button 
                                    type="button" 
                                    class="btn btn-light"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="turnOff('out1')">
                                    <i class="bi bi-dash-circle me-1"></i>
                                    OFF
                                </button>
                                <button 
                                    type="button" 
                                    class="btn btn-warning"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="pulse('out1')">
                                    <i class="bi bi-stopwatch me-1"></i>
                                    PULSE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Relay OUT2 -->
                <div class="col-md-6">
                    <div class="relay-card" [ngClass]="getRelayStateClass('out2')">
                        <div class="relay-header">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0 text-white">
                                    <i [ngClass]="getRelayStateIcon('out2')" class="me-2"></i>
                                    Relay OUT2
                                </h6>
                                <span class="badge bg-white text-dark">
                                    {{ relayState.out2.toUpperCase() }}
                                </span>
                            </div>
                            <p class="small mb-3 text-white-50">
                                Common use: Pump / External device
                            </p>
                        </div>

                        <div class="relay-controls">
                            <div class="btn-group w-100" role="group">
                                <button 
                                    type="button" 
                                    class="btn btn-light"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="turnOn('out2')">
                                    <i class="bi bi-power me-1"></i>
                                    ON
                                </button>
                                <button 
                                    type="button" 
                                    class="btn btn-light"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="turnOff('out2')">
                                    <i class="bi bi-dash-circle me-1"></i>
                                    OFF
                                </button>
                                <button 
                                    type="button" 
                                    class="btn btn-warning"
                                    [disabled]="!mqttConnected || loading"
                                    (click)="pulse('out2')">
                                    <i class="bi bi-stopwatch me-1"></i>
                                    PULSE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pulse Duration Setting -->
            <div class="mt-3">
                <card class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <label class="form-label mb-0">
                                    <i class="bi bi-clock me-1"></i>
                                    Pulse Duration
                                </label>
                                <small class="text-muted d-block">Duration for PULSE action (auto-off)</small>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input 
                                        type="number" 
                                        class="form-control" 
                                        [(ngModel)]="pulseDuration"
                                        min="1"
                                        max="60"
                                        step="1">
                                    <span class="input-group-text">seconds</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </card>
            </div>

            <!-- Command History -->
            <div class="mt-4" *ngIf="commandHistory.length > 0">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">
                        <i class="bi bi-clock-history me-1"></i>
                        Command History
                    </h6>
                    <button 
                        type="button" 
                        class="btn btn-sm btn-outline-danger"
                        (click)="clearHistory()">
                        <i class="bi bi-trash me-1"></i>
                        Clear
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Target</th>
                                <th>Action</th>
                                <th>Status</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let entry of commandHistory">
                                <td class="text-nowrap">
                                    <small>{{ entry.timestamp | date:'short' }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ entry.target.toUpperCase() }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ entry.action.toUpperCase() }}</span>
                                </td>
                                <td>
                                    <span class="badge" [ngClass]="entry.success ? 'bg-success' : 'bg-danger'">
                                        <i class="bi" [ngClass]="entry.success ? 'bi-check-circle' : 'bi-x-circle'"></i>
                                        {{ entry.success ? 'Success' : 'Failed' }}
                                    </span>
                                </td>
                                <td>
                                    <small class="text-muted">{{ entry.message }}</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Info Box -->
            <div class="alert alert-info mt-3 mb-0">
                <i class="bi bi-info-circle me-2"></i>
                <strong>How it works:</strong>
                <ul class="mb-0 mt-2">
                    <li><strong>ON:</strong> Turn relay ON continuously</li>
                    <li><strong>OFF:</strong> Turn relay OFF</li>
                    <li><strong>PULSE:</strong> Turn ON briefly, then automatically turn OFF after specified duration</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" *ngIf="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Sending command...</span>
        </div>
        <p class="mt-2 mb-0">Sending command...</p>
    </div>
</card>
