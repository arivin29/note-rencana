<div class="d-flex align-items-center mb-3">
    <div>
        <ul class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a href="javascript:;">IoT</a></li>
            <li class="breadcrumb-item"><a href="javascript:;">Nodes</a></li>
            <li class="breadcrumb-item active">Sensor Detail</li>
        </ul>
        <h1 class="page-header mb-0">{{ sensorName }}</h1>
        <div class="text-muted text-opacity-75 small">
            {{ sensorType }} channel • {{ sensorUnit | uppercase }} • {{ sensorLocation }}
        </div>
    </div>
    <div class="ms-auto d-flex flex-wrap gap-2">
        <button class="btn btn-outline-theme btn-sm" (click)="applyFilters()">
            <i class="fa fa-sync fa-fw me-1"></i>
            Sync Telemetry
        </button>
        <button class="btn btn-outline-default btn-sm">
            <i class="fa fa-sliders-h fa-fw me-1"></i>
            Set Threshold
        </button>
        <button class="btn btn-outline-default btn-sm" (click)="openEditChannelDrawer()">
            <i class="fa fa-pen fa-fw me-1"></i>
            Edit Channel
        </button>
        <button class="btn btn-theme btn-sm" (click)="exportToCSV()">
            <i class="fa fa-download fa-fw me-1"></i>
            Export CSV
        </button>
    </div>
</div>

<div class="mb-sm-4 mb-3 d-sm-flex">
    <div class="mt-sm-0 mt-2">
        <a href="javascript:;" class="text-inverse text-opacity-75 text-decoration-none">
            <i class="fa fa-thermometer-half fa-fw me-1 text-theme"></i>
            View Node Detail
        </a>
    </div>
    <div class="ms-sm-4 mt-sm-0 mt-2">
        <a href="javascript:;" class="text-inverse text-opacity-75 text-decoration-none">
            <i class="fa fa-bell fa-fw me-1 text-theme"></i>
            Configure Alerts
        </a>
    </div>
    <div class="ms-sm-4 mt-sm-0 mt-2">
        <a href="javascript:;" class="text-inverse text-opacity-75 text-decoration-none">
            <i class="fa fa-microchip fa-fw me-1 text-theme"></i>
            Assign Sensor Profile
        </a>
    </div>
</div>

<!-- Sensor Overview -->
<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <card class="shadow-sm h-100">
            <card-body class="p-3">
                <div class="text-muted text-uppercase small mb-1">Channel Code</div>
                <div class="fs-4 fw-semibold text-inverse">{{ channelMeta.channelId }}</div>
                <div class="text-muted small">
                    Last sample:
                    {{ displayedReadings[0]?.timestamp ? (displayedReadings[0]?.timestamp | date:'dd MMM, HH:mm') :
                    'Belum ada data' }}
                </div>
            </card-body>
        </card>
    </div>
    <div class="col-lg-3 col-md-6">
        <card class="shadow-sm h-100">
            <card-body class="p-3">
                <div class="text-muted text-uppercase small mb-1">Node Location</div>
                <div class="fw-semibold text-inverse">{{ sensorLocation }}</div>
                <div class="text-muted small">Sensor type: {{ sensorType }}</div>
                <div class="text-muted small">Metric: {{ channelMeta.metricCode }}</div>
            </card-body>
        </card>
    </div>
    <div class="col-lg-3 col-md-6">
        <card class="shadow-sm h-100">
            <card-body class="p-3">
                <div class="text-muted text-uppercase small mb-1">Total Records</div>
                <div class="d-flex align-items-baseline gap-2">
                    <div class="fs-3 fw-bold text-theme">{{ totalRecords | number }}</div>
                    <div class="text-muted small text-uppercase">logs</div>
                </div>
                <div class="text-muted small">Dalam periode {{ getSelectedPeriodLabel() }}</div>
            </card-body>
        </card>
    </div>
    <div class="col-lg-3 col-md-6">
        <card class="shadow-sm h-100">
            <card-body class="p-3">
                <div class="text-muted text-uppercase small mb-1">Satuan & Ambang</div>
                <div class="fs-4 fw-semibold text-inverse text-uppercase">{{ sensorUnit }}</div>
                <div class="d-flex flex-wrap gap-2 mt-2">
                    <span class="badge bg-success text-uppercase">MIN {{ channelMeta.minThreshold }} {{ sensorUnit }}</span>
                    <span class="badge bg-danger text-uppercase">MAX {{ channelMeta.maxThreshold }} {{ sensorUnit }}</span>
                </div>
                <div class="text-muted small mt-2">Auto alert di luar rentang aman</div>
            </card-body>
        </card>
    </div>
</div>

<!-- Filters and Table -->
<card class="shadow-sm">
    <ul class="nav nav-tabs nav-tabs-v2 px-4">
        <li class="nav-item me-3" *ngFor="let status of statusOptions">
            <a href="javascript:;" class="nav-link px-2 d-flex align-items-center gap-2"
                [class.active]="selectedStatus === status.value"
                (click)="selectedStatus = status.value; applyFilters()">
                <span>{{ status.value === 'all' ? 'All Status' : status.label }}</span>
                <span class="badge rounded-pill bg-body text-inverse text-opacity-75 border">
                    {{ getStatusCount(status.value) }}
                </span>
            </a>
        </li>
    </ul>
    <div class="p-4">
        <div class="d-flex flex-wrap gap-2 align-items-center mb-4">
            <div class="me-auto">
                <div class="text-muted text-uppercase small mb-1">Data Pembacaan Sensor</div>
                <h4 class="mb-0">Channel Telemetry Stream</h4>
            </div>
            <button class="btn btn-outline-default btn-sm" (click)="applyFilters()">
                <i class="fa fa-bolt fa-fw me-1"></i>
                Refresh
            </button>
            <button class="btn btn-outline-theme btn-sm" (click)="exportToCSV()">
                <i class="fa fa-file-export fa-fw me-1"></i>
                Export CSV
            </button>
        </div>

        <!-- Filters -->
        <div class="row g-3 align-items-end mb-4">
            <div class="col-xl-3 col-md-6">
                <label class="text-muted text-uppercase small d-block mb-1">Periode Data</label>
                <select class="form-select" [(ngModel)]="selectedPeriod" (change)="applyFilters()">
                    <option *ngFor="let period of periodOptions" [value]="period.value">
                        {{ period.label }}
                    </option>
                </select>
            </div>
            <div class="col-xl-3 col-md-6" *ngIf="selectedPeriod === 'custom'">
                <label class="text-muted text-uppercase small d-block mb-1">Dari Tanggal</label>
                <input type="date" class="form-control" [(ngModel)]="dateFrom" (change)="applyFilters()">
            </div>
            <div class="col-xl-3 col-md-6" *ngIf="selectedPeriod === 'custom'">
                <label class="text-muted text-uppercase small d-block mb-1">Sampai Tanggal</label>
                <input type="date" class="form-control" [(ngModel)]="dateTo" (change)="applyFilters()">
            </div>
            <!-- <div class="col-xl-3 col-md-6">
                <label class="text-muted text-uppercase small d-block mb-1">Sinyal Sensor</label>
                <div class="border border-theme border-opacity-25 rounded-3 px-3 py-3 h-100 bg-body bg-opacity-10">
                    <div class="fw-semibold text-inverse">{{ sensorType }}</div>
                    <div class="text-muted small">Telemetry interval 10 menit</div>
                    <div class="badge bg-dark bg-opacity-25 text-uppercase mt-2">Unit {{ sensorUnit }}</div>
                </div>
            </div> -->
        </div>

        <!-- Results Info -->
        <div class="border border-primary border-opacity-25 rounded-3 p-3 bg-body-tertiary mb-4">
            <div class="d-flex flex-wrap gap-3 align-items-center">
                <div>
                    <div class="text-muted text-uppercase small">Window data aktif</div>
                    <div class="fw-semibold">{{ getSelectedPeriodLabel() }}</div>
                </div>
                <div>
                    <div class="text-muted text-uppercase small">Menampilkan</div>
                    <div class="fw-semibold">
                        {{ totalRecords ? ((currentPage - 1) * pageSize + 1) : 0 }} – {{ Math.min(currentPage *
                        pageSize, totalRecords) }}
                        dari {{ totalRecords }} log
                    </div>
                </div>
                <div>
                    <div class="text-muted text-uppercase small">Status filter</div>
                    <div class="fw-semibold text-capitalize">{{ selectedStatus }}</div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="table-responsive">
            <table class="table table-hover text-nowrap align-middle mb-0">
                <thead class="text-uppercase text-muted small">
                    <tr>
                        <th class="pt-0 pb-2">Sample</th>
                        <th class="pt-0 pb-2">Timestamp</th>
                        <th class="pt-0 pb-2">Nilai</th>
                        <th class="pt-0 pb-2">Status</th>
                        <th class="pt-0 pb-2">Kualitas</th>
                        <th class="pt-0 pb-2">Catatan</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let reading of displayedReadings">
                        <td>
                            <div class="fw-semibold">#{{ reading.id }}</div>
                            <div class="text-muted small">Frame ID</div>
                        </td>
                        <td>
                            <div class="fw-semibold">{{ reading.timestamp | date: 'dd MMM yyyy' }}</div>
                            <div class="text-muted small">{{ reading.timestamp | date: 'HH:mm:ss' }}</div>
                        </td>
                        <td>
                            <div class="d-flex align-items-baseline gap-2">
                                <span class="fs-5 fw-bold text-theme">{{ reading.value | number: '1.2-2' }}</span>
                                <span class="text-muted small text-uppercase">{{ reading.unit }}</span>
                            </div>
                            <div class="text-muted small">Δ vs nominal: {{ (reading.value - 5) | number: '1.1-1' }} {{
                                reading.unit }}</div>
                        </td>
                        <td>
                            <span class="badge" [ngClass]="getStatusClass(reading.status)">
                                <i class="fa fa-circle fa-2xs me-1"></i>
                                {{ reading.status | titlecase }}
                            </span>
                        </td>
                        <td class="text-nowrap">
                            <div class="fw-semibold">{{ reading.quality }}%</div>
                            <div class="progress bg-dark bg-opacity-25" [style.height.px]="4">
                                <div class="progress-bar bg-theme" role="progressbar" [style.width.%]="reading.quality">
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="text-muted small" *ngIf="reading.notes; else noNotes">
                                <i class="fa fa-exclamation-triangle me-1 text-warning"></i>
                                {{ reading.notes }}
                            </div>
                            <ng-template #noNotes>
                                <span class="text-muted small">Tidak ada catatan</span>
                            </ng-template>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- No Data Message -->
        <div class="text-center text-muted py-5 border-top" *ngIf="displayedReadings.length === 0">
            Tidak ada data sesuai filter.
        </div>

        <!-- Pagination -->
        <div class="d-md-flex align-items-center mt-4">
            <div class="me-md-auto text-md-start text-center mb-2 mb-md-0">
                Showing {{ totalRecords ? ((currentPage - 1) * pageSize + 1) : 0 }}
                to {{ Math.min(currentPage * pageSize, totalRecords) }} of {{ totalRecords }} records
            </div>
            <div class="d-flex align-items-center justify-content-center mb-2 mb-md-0 me-md-3">
                <span class="text-muted small me-2 text-uppercase">Rows</span>
                <select class="form-select form-select-sm w-auto" [(ngModel)]="pageSize" (change)="onPageSizeChange()">
                    <option *ngFor="let size of pageSizeOptions" [ngValue]="size">{{ size }}</option>
                </select>
            </div>
            <ul class="pagination mb-0 justify-content-center">
                <li class="page-item" [class.disabled]="currentPage === 1">
                    <a class="page-link" href="javascript:;" (click)="goToPage(currentPage - 1)">Previous</a>
                </li>
                <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage"
                    [class.disabled]="page === -1">
                    <a class="page-link" href="javascript:;" (click)="page !== -1 && goToPage(page)">
                        {{ page === -1 ? '...' : page }}
                    </a>
                </li>
                <li class="page-item" [class.disabled]="currentPage === totalPages">
                    <a class="page-link" href="javascript:;" (click)="goToPage(currentPage + 1)">Next</a>
                </li>
            </ul>
        </div>
    </div>
</card>

<app-node-detail-add-channel-drawer
    [isOpen]="isChannelDrawerOpen"
    [sensorId]="channelMeta.sensorId"
    [sensorLabel]="channelMeta.channelId"
    [sensorTypeOptions]="sensorTypeOptions"
    [mode]="channelDrawerMode"
    [initialValue]="channelFormValue"
    (close)="handleChannelDrawerClose()"
    (save)="handleChannelSave($event)">
</app-node-detail-add-channel-drawer>
