<div class="d-flex align-items-center mb-3">
    <div>
        <ul class="breadcrumb mb-1">
            <li class="breadcrumb-item"><a href="javascript:;">IoT</a></li>
            <li class="breadcrumb-item"><a routerLink="/iot/owners">Owners</a></li>
            <li class="breadcrumb-item active">{{ ownerProfile.name || 'Loading...' }}</li>
        </ul>
        <h1 class="page-header mb-0">Owner {{ ownerProfile.name || 'Loading...' }}</h1>
        <div class="text-muted small text-opacity-75">
            {{ ownerProfile.industry }} â€¢ PIC {{ ownerProfile.contactPerson }}
        </div>
    </div>
    <div class="ms-auto d-flex gap-2 flex-wrap">
        <a [routerLink]="['/iot/owners', ownerId, 'edit']" class="btn btn-outline-theme">
            <i class="fa fa-pen fa-fw me-1"></i>
            Edit Owner
        </a>
        <a routerLink="/iot/owners" class="btn btn-outline-default">Back</a>
    </div>
</div>

<!-- Loading State -->
<div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-theme" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-3 text-muted">Loading owner details...</div>
</div>

<!-- Error State -->
<div *ngIf="error && !loading" class="alert alert-danger">
    <i class="fa fa-exclamation-triangle me-2"></i>
    {{ error }}
    <button class="btn btn-sm btn-danger ms-3" (click)="loadOwnerDetail()">
        <i class="fa fa-refresh me-1"></i> Retry
    </button>
</div>

<!-- Content -->
<div *ngIf="!loading && !error"  class="row g-3 mb-4">
    <div class="col-lg-4">
        <card class="shadow-sm h-100">
            <card-header class=" text-uppercase small text-muted">
                Owner Snapshot
            </card-header>
            <card-body>
                <div class="mb-3">
                    <div class="text-muted small">Contact Person</div>
                    <div class="fw-semibold">{{ ownerProfile.contactPerson }}</div>
                    <div class="text-muted small">{{ ownerProfile.email }}</div>
                    <div class="text-muted small">{{ ownerProfile.phone }}</div>
                </div>
                <div class="d-flex gap-3 flex-wrap">
                    <div>
                        <div class="text-muted small text-uppercase">Projects</div>
                        <div class="fs-4 fw-bold">{{ ownerProfile.projects }}</div>
                    </div>
                    <div>
                        <div class="text-muted small text-uppercase">Nodes</div>
                        <div class="fs-4 fw-bold">{{ ownerProfile.nodes }}</div>
                    </div>
                    <div>
                        <div class="text-muted small text-uppercase">Sensors</div>
                        <div class="fs-4 fw-bold">{{ ownerProfile.sensors }}</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="text-muted small">Forwarding Health</div>
                    <span class="badge bg-success-subtle text-success text-uppercase">{{ ownerProfile.forwardingStatus
                        }}</span>
                </div>
            </card-body>
        </card>
    </div>
    <div class="col-lg-8">
        <card id="delivery-config" class="shadow-sm h-100">
            <card-header class=" d-flex flex-wrap gap-3 align-items-center">
                <div>
                    <div class="text-uppercase text-muted small">Data Delivery</div>
                    <div class="fw-semibold">Forwarding Configuration</div>
                </div>
                <ul class="nav nav-pills ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeDeliveryTab === 'webhook'"
                            (click)="setActiveDeliveryTab('webhook')">Webhook</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeDeliveryTab === 'mysql'"
                            (click)="setActiveDeliveryTab('mysql')">MySQL</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeDeliveryTab === 'postgres'"
                            (click)="setActiveDeliveryTab('postgres')">PostgreSQL</a>
                    </li>
                </ul>
            </card-header>
            <card-body>
                <div *ngIf="activeDeliveryTab === 'webhook'">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <div>
                            <div class="text-uppercase text-muted small">Webhook Endpoint</div>
                            <h5 class="mb-0">{{ webhookConfig.label }}</h5>
                        </div>
                        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" id="webhookToggle"
                                [(ngModel)]="webhookConfig.enabled" (change)="onWebhookToggle($event.target.checked)">
                            <label class="form-check-label" for="webhookToggle">
                                {{ webhookConfig.enabled ? 'Enabled' : 'Disabled' }}
                            </label>
                        </div>
                    </div>
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label text-muted small text-uppercase">Endpoint URL</label>
                            <input class="form-control" [(ngModel)]="webhookConfig.endpointUrl" name="endpointUrl">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small text-uppercase">Method</label>
                            <select class="form-select" [(ngModel)]="webhookConfig.httpMethod" name="httpMethod">
                                <option value="POST">POST</option>
                                <option value="PUT">PUT</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">Secret Token</label>
                            <input class="form-control" [(ngModel)]="webhookConfig.secretToken" name="secretToken">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase">Payload Format</label>
                            <select class="form-select" [(ngModel)]="webhookConfig.payloadFormat" name="payloadFormat">
                                <option value="timeseries">Timeseries Envelope</option>
                                <option value="raw">Raw Channel Payload</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label text-muted small text-uppercase mb-0">Custom Headers</label>
                                <button class="btn btn-link btn-sm" (click)="addWebhookHeader()">
                                    <i class="fa fa-plus me-1"></i>
                                    Add Header
                                </button>
                            </div>
                            <div class="row g-2 align-items-end"
                                *ngFor="let header of webhookConfig.headers; let i = index">
                                <div class="col-md-5">
                                    <input class="form-control" placeholder="Header" [(ngModel)]="header.key"
                                        [name]="'headerKey' + i">
                                </div>
                                <div class="col-md-6">
                                    <input class="form-control" placeholder="Value" [(ngModel)]="header.value"
                                        [name]="'headerValue' + i">
                                </div>
                                <div class="col-md-1 text-end">
                                    <button class="btn btn-outline-danger btn-sm" (click)="removeWebhookHeader(i)">
                                        <i class="fa fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small text-uppercase">Max Retry</label>
                            <input type="number" class="form-control" [(ngModel)]="webhookConfig.retry.maxRetry"
                                name="maxRetry">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small text-uppercase">Backoff (ms)</label>
                            <input type="number" class="form-control" [(ngModel)]="webhookConfig.retry.backoffMs"
                                name="backoff">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small text-uppercase">Last Delivery</label>
                            <div class="fw-semibold">
                                {{ webhookConfig.lastDeliveryAt ? (webhookConfig.lastDeliveryAt | date:'dd MMM HH:mm') :
                                'Never' }}
                            </div>
                            <div class="text-muted small">{{ webhookConfig.lastStatus }}</div>
                        </div>
                    </div>
                    <div class="d-flex flex-wrap gap-2 mt-4">
                        <button class="btn btn-outline-theme" (click)="testWebhookDelivery()" [disabled]="!webhookId">
                            <i class="fa fa-bolt me-1"></i>
                            Test Delivery
                        </button>
                        <button class="btn btn-theme" (click)="saveWebhookConfig()">
                            <i class="fa fa-save me-1"></i>
                            Save Webhook Config
                        </button>
                    </div>
                    <div class="alert mt-3" *ngIf="webhookTestMessage" 
                         [ngClass]="{
                           'alert-success': webhookTestMessage.includes('success') || webhookTestMessage.includes('saved') || webhookTestMessage.includes('created') || webhookTestMessage.includes('succeeded'),
                           'alert-danger': webhookTestMessage.includes('Error') || webhookTestMessage.includes('failed'),
                           'alert-info': !webhookTestMessage.includes('success') && !webhookTestMessage.includes('Error') && !webhookTestMessage.includes('failed')
                         }">
                        <i class="fa me-2" [ngClass]="{
                          'fa-check-circle': webhookTestMessage.includes('success') || webhookTestMessage.includes('succeeded'),
                          'fa-exclamation-triangle': webhookTestMessage.includes('Error') || webhookTestMessage.includes('failed'),
                          'fa-info-circle': !webhookTestMessage.includes('success') && !webhookTestMessage.includes('Error')
                        }"></i>
                        {{ webhookTestMessage }}
                    </div>
                </div>

                <div *ngIf="activeDeliveryTab === 'mysql' || activeDeliveryTab === 'postgres'">
                    <div class="row g-3">
                        <div class="col-12" *ngFor="let config of getDatabaseConfigsByType(activeDeliveryTab)">
                            <card class="border bg-body-secondary bg-opacity-25">
                                <card-body>
                                    <div class="d-flex align-items-center justify-content-between mb-3">
                                        <div>
                                            <div class="text-uppercase text-muted small">{{ config.label }}</div>
                                            <div class="fw-semibold text-muted">{{ config.host }}:{{ config.port }}
                                            </div>
                                        </div>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox"
                                                [id]="'dbToggle' + config.id" [(ngModel)]="config.enabled"
                                                (change)="toggleDatabaseEnabled(config, $event.target.checked)">
                                            <label class="form-check-label" [for]="'dbToggle' + config.id">
                                                {{ config.enabled ? 'Enabled' : 'Disabled' }}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label text-muted small text-uppercase">Host</label>
                                            <input class="form-control" [(ngModel)]="config.host"
                                                [name]="'host' + config.id">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label text-muted small text-uppercase">Port</label>
                                            <input type="number" class="form-control" [(ngModel)]="config.port"
                                                [name]="'port' + config.id">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-muted small text-uppercase">Database</label>
                                            <input class="form-control" [(ngModel)]="config.database"
                                                [name]="'db' + config.id">
                                        </div>
                                        <div class="col-md-4" *ngIf="config.type === 'postgres'">
                                            <label class="form-label text-muted small text-uppercase">Schema</label>
                                            <input class="form-control" [(ngModel)]="config.schema"
                                                [name]="'schema' + config.id">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-muted small text-uppercase">Username</label>
                                            <input class="form-control" [(ngModel)]="config.username"
                                                [name]="'user' + config.id">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label text-muted small text-uppercase">Password</label>
                                            <input type="password" class="form-control" [(ngModel)]="config.password"
                                                [name]="'pass' + config.id">
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label text-muted small text-uppercase">Target
                                                Table</label>
                                            <input class="form-control" [(ngModel)]="config.targetTable"
                                                [name]="'table' + config.id">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label text-muted small text-uppercase">Write Mode</label>
                                            <select class="form-select" [(ngModel)]="config.writeMode"
                                                [name]="'mode' + config.id">
                                                <option value="append">Append</option>
                                                <option value="upsert">Upsert</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label text-muted small text-uppercase">Batch Size</label>
                                            <input type="number" class="form-control" [(ngModel)]="config.batchSize"
                                                [name]="'batch' + config.id">
                                        </div>
                                        <div class="col-md-2">
                                            <label class="form-label text-muted small text-uppercase">Status</label>
                                            <div class="fw-semibold text-capitalize">{{ config.lastStatus || 'Unknown'
                                                }}</div>
                                            <div class="text-muted small">
                                                {{ config.lastDeliveryAt ? (config.lastDeliveryAt | date:'dd MMM HH:mm')
                                                : 'Never' }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2 mt-3">
                                        <button class="btn btn-outline-theme btn-sm"
                                            (click)="testDatabaseConnection(config)">
                                            <i class="fa fa-link me-1"></i>
                                            Test Connection
                                        </button>
                                        <button class="btn btn-theme btn-sm" (click)="saveDatabaseConfig(config)">
                                            <i class="fa fa-save me-1"></i>
                                            Save Config
                                        </button>
                                    </div>
                                    <!-- Test/Save Message for MySQL -->
                                    <div class="alert mt-3" *ngIf="config.type === 'mysql' && mysqlTestMessage" 
                                         [ngClass]="{
                                           'alert-success': mysqlTestMessage.includes('success') || mysqlTestMessage.includes('saved') || mysqlTestMessage.includes('created') || mysqlTestMessage.includes('succeeded'),
                                           'alert-danger': mysqlTestMessage.includes('Error') || mysqlTestMessage.includes('failed'),
                                           'alert-info': !mysqlTestMessage.includes('success') && !mysqlTestMessage.includes('Error') && !mysqlTestMessage.includes('failed')
                                         }">
                                        <i class="fa me-2" [ngClass]="{
                                          'fa-check-circle': mysqlTestMessage.includes('success') || mysqlTestMessage.includes('succeeded'),
                                          'fa-exclamation-triangle': mysqlTestMessage.includes('Error') || mysqlTestMessage.includes('failed'),
                                          'fa-info-circle': !mysqlTestMessage.includes('success') && !mysqlTestMessage.includes('Error')
                                        }"></i>
                                        {{ mysqlTestMessage }}
                                    </div>
                                    <!-- Test/Save Message for PostgreSQL -->
                                    <div class="alert mt-3" *ngIf="config.type === 'postgres' && postgresTestMessage" 
                                         [ngClass]="{
                                           'alert-success': postgresTestMessage.includes('success') || postgresTestMessage.includes('saved') || postgresTestMessage.includes('created') || postgresTestMessage.includes('succeeded'),
                                           'alert-danger': postgresTestMessage.includes('Error') || postgresTestMessage.includes('failed'),
                                           'alert-info': !postgresTestMessage.includes('success') && !postgresTestMessage.includes('Error') && !postgresTestMessage.includes('failed')
                                         }">
                                        <i class="fa me-2" [ngClass]="{
                                          'fa-check-circle': postgresTestMessage.includes('success') || postgresTestMessage.includes('succeeded'),
                                          'fa-exclamation-triangle': postgresTestMessage.includes('Error') || postgresTestMessage.includes('failed'),
                                          'fa-info-circle': !postgresTestMessage.includes('success') && !postgresTestMessage.includes('Error')
                                        }"></i>
                                        {{ postgresTestMessage }}
                                    </div>
                                </card-body>
                            </card>
                        </div>
                    </div>
                </div>
            </card-body>
        </card>
    </div>
</div>

<card class="shadow-sm">
    <card-header class=" d-flex align-items-center">
        <div>
            <div class="text-muted text-uppercase small">Forwarding Activity</div>
            <h5 class="mb-0">Recent Delivery Attempts</h5>
        </div>
        <span class="badge bg-dark bg-opacity-25 ms-auto">Last 24h</span>
    </card-header>
    <card-body class="p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="text-muted text-uppercase small">
                    <tr>
                        <th>Time</th>
                        <th>Target</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Message</th>
                        <th class="text-end">Latency</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let log of forwardingLogs">
                        <td>
                            <div class="fw-semibold">{{ log.timestamp }}</div>
                            <div class="text-muted small">Attempts: {{ log.attempts }}</div>
                        </td>
                        <td>{{ log.target }}</td>
                        <td class="text-capitalize">{{ log.type }}</td>
                        <td>
                            <span class="badge"
                                [ngClass]="{'bg-success': log.status === 'success', 'bg-danger': log.status === 'failed', 'bg-warning text-dark': log.status === 'pending'}">
                                {{ log.status | titlecase }}
                            </span>
                        </td>
                        <td>{{ log.message }}</td>
                        <td class="text-end">{{ log.durationMs }} ms</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </card-body>
</card>
<!-- End of ngIf content wrapper -->
