<!-- BEGIN users-list -->
<div class="d-flex align-items-center mb-3">
  <div>
    <h1 class="page-header mb-0">User Management</h1>
    <p class="text-muted">Manage system users and permissions</p>
  </div>
  <div class="ms-auto">
    <button class="btn btn-theme" (click)="openCreateModal()">
      <i class="bi bi-plus-lg me-2"></i>Create User
    </button>
  </div>
</div>

<!-- Success/Error Messages -->
<div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
  <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
  <button type="button" class="btn-close" (click)="successMessage = ''" aria-label="Close"></button>
</div>

<div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
  <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
  <button type="button" class="btn-close" (click)="errorMessage = ''" aria-label="Close"></button>
</div>

<!-- Filters Card -->
<div class="card border-0 mb-3">
  <div class="card-body">
    <div class="row g-3">
      <!-- Search -->
      <div class="col-md-4">
        <div class="input-group">
          <input 
            type="text" 
            class="form-control" 
            placeholder="Search by name or email..."
            [(ngModel)]="searchQuery"
            (keyup.enter)="onSearch()">
          <button class="btn btn-outline-theme" type="button" (click)="onSearch()">
            <i class="bi bi-search"></i>
          </button>
        </div>
      </div>

      <!-- Role Filter -->
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="filterRole" (change)="onFilterChange()">
          <option value="">All Roles</option>
          <option value="admin">Admin</option>
          <option value="tenant">Tenant</option>
        </select>
      </div>

      <!-- Status Filter -->
      <div class="col-md-3">
        <select class="form-select" [(ngModel)]="filterStatus" (change)="onFilterChange()">
          <option value="">All Status</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>

      <!-- Reset Button -->
      <div class="col-md-2">
        <button class="btn btn-outline-secondary w-100" (click)="searchQuery=''; filterRole=''; filterStatus=''; onFilterChange()">
          <i class="bi bi-arrow-clockwise me-1"></i>Reset
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Users Table Card -->
<div class="card border-0">
  <div class="card-body">
    <!-- Loading State -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-theme" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Loading users...</p>
    </div>

    <!-- Users Table -->
    <div *ngIf="!loading" class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th class="sortable" (click)="onSort('name')">
              Name
              <i class="bi ms-1" [ngClass]="{
                'bi-chevron-up': sortBy === 'name' && sortOrder === 'asc',
                'bi-chevron-down': sortBy === 'name' && sortOrder === 'desc',
                'bi-chevron-expand': sortBy !== 'name'
              }"></i>
            </th>
            <th class="sortable" (click)="onSort('email')">
              Email
              <i class="bi ms-1" [ngClass]="{
                'bi-chevron-up': sortBy === 'email' && sortOrder === 'asc',
                'bi-chevron-down': sortBy === 'email' && sortOrder === 'desc',
                'bi-chevron-expand': sortBy !== 'email'
              }"></i>
            </th>
            <th>Role</th>
            <th>Status</th>
            <th class="sortable" (click)="onSort('createdAt')">
              Created
              <i class="bi ms-1" [ngClass]="{
                'bi-chevron-up': sortBy === 'createdAt' && sortOrder === 'asc',
                'bi-chevron-down': sortBy === 'createdAt' && sortOrder === 'desc',
                'bi-chevron-expand': sortBy !== 'createdAt'
              }"></i>
            </th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td>
              <div class="d-flex align-items-center">
                <div class="rounded-circle bg-theme text-white d-flex align-items-center justify-content-center me-2" 
                     style="width: 32px; height: 32px; font-size: 0.9rem; font-weight: 600;">
                  {{ user.name.charAt(0).toUpperCase() }}
                </div>
                <div>
                  <div class="fw-bold">{{ user.name }}</div>
                  <small class="text-muted" *ngIf="user.idOwner">Owner: {{ user.idOwner }}</small>
                </div>
              </div>
            </td>
            <td>
              <span class="text-muted">{{ user.email }}</span>
            </td>
            <td>
              <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
                <i class="bi bi-shield-check me-1"></i>{{ user.role | uppercase }}
              </span>
            </td>
            <td>
              <span class="badge" [ngClass]="getStatusBadgeClass(user.isActive)">
                <i class="bi bi-circle-fill me-1" style="font-size: 0.5rem;"></i>
                {{ user.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>
              <span class="text-muted small">{{ formatDate(user.createdAt) }}</span>
            </td>
            <td class="text-end">
              <div class="btn-group btn-group-sm">
                <button 
                  class="btn btn-outline-info" 
                  [routerLink]="['/admin/users', user.idUser]"
                  title="View details">
                  <i class="bi bi-eye"></i>
                </button>
                <button 
                  class="btn btn-outline-theme" 
                  (click)="openEditModal(user)"
                  title="Edit user">
                  <i class="bi bi-pencil"></i>
                </button>
                <button 
                  class="btn btn-outline-warning" 
                  (click)="toggleUserStatus(user)"
                  [title]="user.isActive ? 'Deactivate user' : 'Activate user'">
                  <i class="bi" [ngClass]="user.isActive ? 'bi-toggle-on' : 'bi-toggle-off'"></i>
                </button>
                <button 
                  class="btn btn-outline-danger" 
                  (click)="deleteUser(user)"
                  title="Delete user">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="users.length === 0">
            <td colspan="6" class="text-center py-5">
              <i class="bi bi-inbox display-4 text-muted d-block mb-3"></i>
              <p class="text-muted">No users found</p>
              <button class="btn btn-theme btn-sm" (click)="openCreateModal()">
                <i class="bi bi-plus-lg me-2"></i>Create First User
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="!loading && users.length > 0" class="d-flex justify-content-between align-items-center mt-3">
      <div class="text-muted small">
        Showing {{ getShowingFrom() }} to {{ getShowingTo() }} of {{ totalUsers }} users
      </div>
      
      <nav aria-label="Users pagination">
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item" [class.disabled]="currentPage === 1">
            <a class="page-link" (click)="onPageChange(currentPage - 1)" aria-label="Previous">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
          
          <li class="page-item" *ngFor="let page of getPageNumbers()" [class.active]="page === currentPage">
            <a class="page-link" (click)="onPageChange(page)">{{ page }}</a>
          </li>
          
          <li class="page-item" [class.disabled]="currentPage === totalPages">
            <a class="page-link" (click)="onPageChange(currentPage + 1)" aria-label="Next">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </div>
</div>

<!-- User Form Modal Component -->
<app-user-form-modal
  *ngIf="showModal"
  [mode]="modalMode"
  [user]="selectedUser"
  (close)="closeModal()"
  (save)="onUserSaved($event)">
</app-user-form-modal>
<!-- END users-list -->
