<div class="container-fluid">
  <!-- Header with Back Button -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex align-items-center">
        <button class="btn btn-outline-secondary me-3" (click)="goBack()">
          <i class="bi bi-arrow-left me-2"></i>Back
        </button>
        <h2 class="mb-0">User Details</h2>
      </div>
    </div>
  </div>

  <!-- Alert Messages -->
  <div class="row" *ngIf="successMessage || errorMessage">
    <div class="col-12">
      <div class="alert alert-success alert-dismissible fade show" *ngIf="successMessage" role="alert">
        <i class="bi bi-check-circle me-2"></i>{{ successMessage }}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
      </div>
      <div class="alert alert-danger alert-dismissible fade show" *ngIf="errorMessage" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>{{ errorMessage }}
        <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="row" *ngIf="loading && !user">
    <div class="col-12 text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3">Loading user details...</p>
    </div>
  </div>

  <!-- User Details Content -->
  <div class="row" *ngIf="!loading && user">
    <!-- Left Column: User Info & Quick Actions -->
    <div class="col-lg-4 mb-4">
      <!-- User Info Card -->
      <card>
        <div class="card shadow-sm">
            <div class="card-body text-center">
                <!-- Avatar -->
                <div class="user-avatar mx-auto mb-3">
                    {{ getUserInitials() }}
                </div>
        
                <!-- User Name -->
                <h3 class="mb-1">{{ user.name }}</h3>
                <p class="text-muted mb-3">{{ user.email }}</p>
        
                <!-- Role & Status Badges -->
                <div class="mb-3">
                    <span class="badge me-2" [ngClass]="getRoleBadgeClass(user.role)">
                        <i class="bi bi-shield me-1"></i>{{ user.role | uppercase }}
                    </span>
                    <span class="badge" [ngClass]="getStatusBadgeClass(user.isActive)">
                        <i class="bi" [ngClass]="user.isActive ? 'bi-check-circle' : 'bi-x-circle'"></i>
                        {{ user.isActive ? 'Active' : 'Inactive' }}
                    </span>
                </div>
        
                <hr>
        
                <!-- User Details -->
                <div class="text-start">
                    <div class="detail-item">
                        <i class="bi bi-fingerprint text-muted me-2"></i>
                        <strong>ID:</strong>
                        <span class="ms-2">{{ user.idUser }}</span>
                    </div>
        
                    <div class="detail-item" *ngIf="user.idOwner">
                        <i class="bi bi-building text-muted me-2"></i>
                        <strong>Owner:</strong>
                        <span class="ms-2">
                            <a *ngIf="ownerDetail" [routerLink]="['/iot/owners', ownerDetail.idOwner]">{{ ownerDetail.name
                                }}</a>
                            <span *ngIf="!ownerDetail">{{ user.idOwner }}</span>
                        </span>
                    </div>
        
                    <div class="detail-item">
                        <i class="bi bi-calendar-plus text-muted me-2"></i>
                        <strong>Created:</strong>
                        <span class="ms-2">{{ formatDate(user.createdAt) }}</span>
                    </div>
        
                    <div class="detail-item">
                        <i class="bi bi-calendar-check text-muted me-2"></i>
                        <strong>Updated:</strong>
                        <span class="ms-2">{{ formatDate(user.updatedAt) }}</span>
                    </div>
                </div>
            </div>
        </div>
      </card>

      <!-- Quick Actions Card -->
      <card>
        <div class="card shadow-sm mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-lightning me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-primary" (click)="editUser()" [disabled]="loading">
                        <i class="bi bi-pencil me-2"></i>Edit User
                    </button>
        
                    <button class="btn" [ngClass]="user.isActive ? 'btn-warning' : 'btn-success'" (click)="toggleStatus()"
                        [disabled]="loading">
                        <i class="bi" [ngClass]="user.isActive ? 'bi-pause-circle' : 'bi-play-circle'" class="me-2"></i>
                        {{ user.isActive ? 'Deactivate' : 'Activate' }}
                    </button>
        
                    <button class="btn btn-danger" (click)="showDeleteConfirm = true" [disabled]="loading">
                        <i class="bi bi-trash me-2"></i>Delete User
                    </button>
                </div>
            </div>
        </div>
      </card>
    </div>

    <!-- Right Column: Statistics & Activities -->
    <div class="col-lg-8">
      <!-- Statistics Cards Row -->
      <div class="row mb-4">
        <!-- Total Logins -->
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card shadow-sm stat-card stat-card-primary">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-muted small mb-1">Total Logins</p>
                  <h4 class="mb-0">{{ loadingStats ? '...' : stats.totalLogins }}</h4>
                </div>
                <div class="stat-icon">
                  <i class="bi bi-box-arrow-in-right"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Last Login -->
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card shadow-sm stat-card stat-card-info">
            <div class="card-body">
              <div>
                <p class="text-muted small mb-1">Last Login</p>
                <h6 class="mb-0">{{ loadingStats ? '...' : formatDate(stats.lastLogin) }}</h6>
              </div>
            </div>
          </div>
        </div>

        <!-- Total Actions -->
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card shadow-sm stat-card stat-card-success">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-muted small mb-1">Total Actions</p>
                  <h4 class="mb-0">{{ loadingStats ? '...' : stats.totalActions }}</h4>
                </div>
                <div class="stat-icon">
                  <i class="bi bi-activity"></i>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Account Age -->
        <div class="col-md-3 col-sm-6 mb-3">
          <div class="card shadow-sm stat-card stat-card-warning">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <p class="text-muted small mb-1">Account Age</p>
                  <h4 class="mb-0">{{ stats.accountAge }} <small>days</small></h4>
                </div>
                <div class="stat-icon">
                  <i class="bi bi-calendar3"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Owned Resources (for Tenants) -->
      <div class="row mb-4" *ngIf="user.role === 'tenant'">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header">
              <h5 class="mb-0">
                <i class="bi bi-boxes me-2"></i>Owned Resources
              </h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-4">
                  <div class="resource-item">
                    <i class="bi bi-hdd-network fs-1 text-primary"></i>
                    <h3 class="mt-2 mb-0">{{ ownedResources.nodes }}</h3>
                    <p class="text-muted small">Nodes</p>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="resource-item">
                    <i class="bi bi-folder fs-1 text-success"></i>
                    <h3 class="mt-2 mb-0">{{ ownedResources.projects }}</h3>
                    <p class="text-muted small">Projects</p>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="resource-item">
                    <i class="bi bi-cpu fs-1 text-warning"></i>
                    <h3 class="mt-2 mb-0">{{ ownedResources.sensors }}</h3>
                    <p class="text-muted small">Sensors</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Activities -->
      <div class="row">
        <div class="col-12">
          <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">
                <i class="bi bi-clock-history me-2"></i>Recent Activities
              </h5>
              <small class="text-muted">Last 10 actions</small>
            </div>
            <div class="card-body p-0">
              <!-- Loading -->
              <div class="text-center py-4" *ngIf="loadingStats">
                <div class="spinner-border spinner-border-sm text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
              </div>

              <!-- Activities Table -->
              <div class="table-responsive" *ngIf="!loadingStats && recentActivities.length > 0">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Action</th>
                      <th>Description</th>
                      <th>Status</th>
                      <th>Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let activity of recentActivities">
                      <td>
                        <span class="badge" [ngClass]="getActionBadgeClass(activity.action)">
                          {{ activity.action }}
                        </span>
                      </td>
                      <td>{{ activity.description }}</td>
                      <td>
                        <span class="badge" [ngClass]="activity.status === 'success' ? 'badge-success' : 'badge-danger'">
                          <i class="bi" [ngClass]="activity.status === 'success' ? 'bi-check-circle' : 'bi-x-circle'"></i>
                          {{ activity.status }}
                        </span>
                      </td>
                      <td>{{ formatDate(activity.createdAt) }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- No Activities -->
              <div class="text-center py-4" *ngIf="!loadingStats && recentActivities.length === 0">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="text-muted mt-2">No recent activities</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-backdrop" *ngIf="showDeleteConfirm" (click)="showDeleteConfirm = false"></div>
<div class="modal" [class.show]="showDeleteConfirm" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-exclamation-triangle text-danger me-2"></i>Confirm Delete
        </h5>
        <button type="button" class="btn-close" (click)="showDeleteConfirm = false"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to delete this user?</p>
        <p class="text-danger mb-0">
          <strong>Warning:</strong> This action cannot be undone. All user data and associated resources will be permanently deleted.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="showDeleteConfirm = false">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="deleteUser()">
          <i class="bi bi-trash me-2"></i>Delete User
        </button>
      </div>
    </div>
  </div>
</div>

<!-- User Edit Form Modal -->
<app-user-form
  *ngIf="showEditModal && user"
  [mode]="'edit'"
  [user]="user"
  [showAsModal]="true"
  (close)="closeEditModal()"
  (save)="onUserSaved($event)">
</app-user-form>
